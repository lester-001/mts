<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->
<scenario>
    <function name="handleSecurityMode">
        <input>
            <parameter name="[function:nas_pdu_msg]" />
        </input>
    
        <do>    
            <function file="function/validateAutn.xml" />
            <function file="function/calcResp.xml" />
            <function file="nas/IdentityResponse.xml" />
            <function file="nas/AuthenticationResponse.xml" />
            <function file="nas/SecurityComplete.xml" />
            
            <parameter name="[out_ret]" operation="set" value="false"/>  
            <parameter name="[selected_enc_alg]" operation="set" value=""/>
            <parameter name="[selected_int_alg]" operation="set" value=""/>
        
            <parameter name="[selected_enc_alg]" operation="string.xpath" value="[nas_pdu_msg]" value2="//TypeOfCipheringAlgorithm/text()"/>
            <parameter name="[selected_int_alg]" operation="string.xpath" value="[nas_pdu_msg]" value2="//TypeOfIntegrityProtectionAlgorithm/text()"/>

            <if> <condition> <test parameter="[selected_enc_alg]" condition="string.equals" value="" not="true"/> </condition>
                <then>
                    <parameter name="[ue_selected_enc_alg]" operation="set" value="[selected_enc_alg]"/>  
                </then>     
            </if>

            <if> <condition> <test parameter="[selected_int_alg]" condition="string.equals" value="" not="true"/> </condition>
                <then>
                    <parameter name="[ue_selected_int_alg]" operation="set" value="[selected_int_alg]"/>  
                </then>     
            </if>

            <call name="ConvertEncAlg" >
                <output>
                    <parameter name="[function:out_enc_alg]" />
                </output>
            </call>   
            
            <call name="ConvertIntAlg" >
                <output>
                    <parameter name="[function:out_int_alg]" />
                </output>
            </call>   

            <parameter name="[bin_ue_key_amf]" operation="binary.tostring" value="[ue_key_amf]"/>  
            <parameter name="[nas_key]" operation="protocol.setFromNAS" value="[bin_ue_key_amf]" value2="NasKey" value3="[out_enc_alg]" value4="[out_int_alg]"/>

            <parameter name="[selected_kNasEnc]" operation="set" value="[nas_key(0)]"/>  
            <parameter name="[selected_kNasInt]" operation="set" value="[nas_key(1)]"/>  

            <parameter name="[ue_selected_kNasEnc]" operation="set" value="[selected_kNasEnc]"/>  
            <parameter name="[ue_selected_kNasInt]" operation="set" value="[selected_kNasInt]"/>  

            <call name="securityComp" >
                <output> <parameter name="[function:sec_msgd]" /> </output>
            </call>

            <call name="encryptNasMessage" >
                <input>
                    <parameter name="[function:plainNasMessage]" value="[sec_msgd]"/>
                </input>
                <output>
                    <parameter name="[function:out_encrypt_ret]" />
                    <parameter name="[function:out_encrypt_msg]" />
                    <parameter name="[function:out_sqn]" />
                    <parameter name="[function:out_overflow]" />
                </output>
            </call>
            
            <call name="uplinkNas" >
                <input>
                    <parameter name="[function:nas_pdu_msg]"  value="[out_encrypt_msg]"/>
                </input>
            </call> 

            <parameter name="[out_ret]" operation="set" value="true"/>  
        </do>
      
        <output>
            <parameter name="[function:out_ret]" />
            <parameter name="[function:selected_kNasEnc]" />
            <parameter name="[function:selected_kNasInt]" />
            <parameter name="[function:selected_enc_alg]" />
            <parameter name="[function:selected_int_alg]" />
            <parameter name="[function:out_sqn]" />
            <parameter name="[function:out_overflow]" />
        </output>
    </function>
</scenario>
