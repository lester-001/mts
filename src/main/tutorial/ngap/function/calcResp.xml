<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->
<scenario>
    <function name="calcResp">
        <input>
            <parameter name="[function:rand]" />
            <parameter name="[function:sqn]" />
            <parameter name="[function:amf]" />
            <parameter name="[function:indBitLen]" />
            <parameter name="[function:wrappingDelta]" />
            <parameter name="[function:sqnArr]" />
            <parameter name="[function:receivedMAC]" />
        </input>
    
        <do>    
            <parameter name="[sqnresult]" operation="protocol.SQN" value="[indBitLen]" value2="[wrappingDelta]" value3="[sqnArr]" value4="getSqn"/>  

            <parameter name="[mileresult]" operation="protocol.Milenage" value="[ue_key]" value2="[ue_op]" value3="[rand]" value4="[sqnresult]" value5="[amf]"/>  

            <parameter name="[ck]" operation="set" value="[mileresult(0)]"/>  
            <parameter name="[ik]" operation="set" value="[mileresult(1)]"/>  
            <parameter name="[ak]" operation="set" value="[mileresult(2)]"/>  
            <parameter name="[res]" operation="set" value="[mileresult(4)]"/>  
            <parameter name="[ckik]" operation="set" value="[ck][ik]"/>  
            <parameter name="[snn_data]" operation="string.toBinary" value="[ue_snn]" />

            <parameter name="[rand_len]" operation="binary.length" value="[rand]"/> 
            <parameter name="[res_len]" operation="binary.length" value="[res]"/>  
            <parameter name="[snn_data_len]" operation="binary.length" value="[snn_data]"/> 
            <parameter name="[rand_len]" operation="number.toBinary" value="[rand_len]"/> 
            <parameter name="[res_len]" operation="number.toBinary" value="[res_len]"/> 
            <parameter name="[snn_data_len]" operation="number.toBinary" value="[snn_data_len]"/> 

            <parameter name="[param]" operation="set" value="6B[snn_data]00[snn_data_len][rand]00[rand_len][res]00[res_len]"/>  

	        <parameter name="[resStar]" operation="binary.hmac" value="[param]" value2="HmacSHA256" value3="[ckik]" />
            <parameter name="[resStar]" operation="binary.subbinary" value="[resStar]" value2="16" value3="16"/>

            <parameter name="[sqnXorAk]" operation="binary.xor" value="[sqnresult]" value2="[ak]"/>   
            <parameter name="[sqn_xor_ak_len]" operation="binary.length" value="[sqnXorAk]"/>  
            
            <parameter name="[snn_data]" operation="string.toBinary" value="[ue_snn]" />
            <parameter name="[snn_data_len]" operation="binary.length" value="[snn_data]"/> 
            <parameter name="[sqn_xor_ak_len]" operation="number.toBinary" value="[sqn_xor_ak_len]"/> 
            <parameter name="[snn_data_len]" operation="number.toBinary" value="[snn_data_len]"/> 
            
            <parameter name="[param]" operation="set" value="6A[snn_data]00[snn_data_len][sqnXorAk]00[sqn_xor_ak_len]"/>  
	        <parameter name="[key_ausf]" operation="binary.hmac" value="[param]" value2="HmacSHA256" value3="[ckik]" />
        </do>
      
        <output>
            <parameter name="[function:resStar]" />
            <parameter name="[function:key_ausf]" />
        </output>
    </function>
</scenario>
