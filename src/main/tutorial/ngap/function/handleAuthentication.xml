<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->
<scenario>
    <function name="handleAuthentication">
        <input>
            <parameter name="[function:nas_pdu_msg]" />
        </input>
    
        <do>    
            <function file="function/validateAutn.xml" />
            <function file="function/calcResp.xml" />
            <function file="nas/IdentityResponse.xml" />
            <function file="nas/AuthenticationResponse.xml" />
            <function file="nas/SecurityComplete.xml" />
            
            <parameter name="[rand]" operation="set" value="7e9b0ef1e2da0a405845f132061eb8c4"/>  
            <parameter name="[sqn]" operation="set" value="38231fc5562c"/>  
            <parameter name="[amf]" operation="set" value="8000"/>  

            <parameter name="[indBitLen]" operation="set" value="5"/>  
            <parameter name="[wrappingDelta]" operation="set" value="268435456"/>

            <parameter name="[sqnArr(0)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(1)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(2)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(3)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(4)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(5)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(6)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(7)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(8)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(9)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(10)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(11)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(12)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(13)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(14)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(15)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(16)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(17)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(18)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(19)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(20)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(21)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(22)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(23)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(24)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(25)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(26)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(27)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(28)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(29)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(30)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(31)]" operation="set" value="0"/>  
            
            <parameter name="[ret]" operation="set" value="false"/>  

            <parameter name="[selected_enc_alg]" operation="set" value=""/>
            <parameter name="[selected_int_alg]" operation="set" value=""/>

            <parameter name="[ksi]" operation="string.xpath" value="[nas_pdu_msg]" value2="//NasKeySetIdentifierValue/text()" />
            <parameter name="[rand]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AuthenticationParameterRand[1]/Rand/text()" />
            <parameter name="[SqnXorAk]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AuthenticationParameterAutn[1]/SqnXorAk/text()" />
            <parameter name="[Amf]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AuthenticationParameterAutn[1]/Amf/text()" />
            <parameter name="[Mac]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AuthenticationParameterAutn[1]/Mac/text()" />
            
            <parameter name="[abba]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AbbaContent/text()" />

            <call name="validateAutn" >
                <input>
                    <parameter name="[function:rand]" value="[rand]" />
                    <parameter name="[function:sqn]" value="[SqnXorAk]" />
                    <parameter name="[function:amf]" value="[Amf]" />
                    <parameter name="[function:indBitLen]" value="[indBitLen]" />
                    <parameter name="[function:wrappingDelta]" value="[wrappingDelta]" />
                    <parameter name="[function:sqnArr]" value="[sqnArr]" />
                    <parameter name="[function:receivedMAC]" value="[Mac]" />
                </input>

                <output>
                    <parameter name="[function:validated]" /> 
                    <parameter name="[function:osqnArr]" />
                </output>
            </call>

            <if>  <condition> <test parameter="[validated]" condition="string.equals" value="false"/></condition>
                <then>
                    <parameter name="[out_ret]" operation="set" value="true"/>   
                    <exit name="exit" failed="false"/>  
                </then>   
            </if>
            
            <parameter name="[sqnArr]" operation="set" value="[osqnArr]"/>   

            <call name="calcResp" >
                <input>
                    <parameter name="[function:rand]" value="[rand]" />
                    <parameter name="[function:sqn]" value="[SqnXorAk]" />
                    <parameter name="[function:amf]" value="[Amf]" />
                    <parameter name="[function:indBitLen]" value="[indBitLen]" />
                    <parameter name="[function:wrappingDelta]" value="[wrappingDelta]" />
                    <parameter name="[function:sqnArr]" value="[sqnArr]" />
                    <parameter name="[function:receivedMAC]" value="[Mac] " />
                </input>

                <output> 
                    <parameter name="[function:resStar]" /> 
                    <parameter name="[function:key_ausf]" /> 
                </output>
            </call>
            
            <call name="AuthResp" >
                <input>
                    <parameter name="[function:res_param]"  value="[resStar]"/>
                </input>

                <output> <parameter name="[function:Auth_msgd]" /> </output>
            </call>

            <parameter name="[bin_ausf]" operation="binary.tostring" value="[key_ausf]"/>   
            <parameter name="[bin_abba]" operation="binary.tostring" value="[abba]"/>  
            <parameter name="[oSeafAmf]" operation="protocol.setFromNAS" value="[ue_supi]" value2="SeafAmf" value3="[ue_snn]" value4="[bin_abba]" value5="[bin_ausf]"/>
     

            <parameter name="[send_nas_pdu_msgd]" operation="set" value="[Auth_msgd]"/>   

            <call name="uplinkNas" >
                <input>
                    <parameter name="[function:nas_pdu_msg]"  value="[send_nas_pdu_msgd]"/>
                </input>
            </call> 

            <parameter name="[out_ret]" operation="set" value="true"/>   
            <parameter name="[key_seaf]" operation="set" value="[oSeafAmf(0)]"/>   
            <parameter name="[key_amf]" operation="set" value="[oSeafAmf(1)]"/>  
        </do>
      
        <output>
            <parameter name="[function:out_ret]" />
            <parameter name="[function:key_seaf]" />
            <parameter name="[function:key_amf]" />
            <parameter name="[function:key_ausf]" />
        </output>
    </function>
</scenario>
