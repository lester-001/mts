<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->
<scenario>
    <function name="handleNasPdu">
        <input>
            <parameter name="[function:nas_pdu_msg]" />
        </input>
    
        <do>    
            <function file="function/validateAutn.xml" />
            <function file="function/calcResp.xml" />
            <function file="nas/IdentityResponse.xml" />
            <function file="nas/AuthenticationResponse.xml" />
            <function file="nas/SecurityComplete.xml" />
            
            <parameter name="[rand]" operation="set" value="7e9b0ef1e2da0a405845f132061eb8c4"/>  
            <parameter name="[sqn]" operation="set" value="38231fc5562c"/>  
            <parameter name="[amf]" operation="set" value="8000"/>  

            <parameter name="[indBitLen]" operation="set" value="5"/>  
            <parameter name="[wrappingDelta]" operation="set" value="268435456"/>

            <parameter name="[sqnArr(0)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(1)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(2)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(3)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(4)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(5)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(6)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(7)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(8)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(9)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(10)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(11)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(12)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(13)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(14)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(15)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(16)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(17)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(18)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(19)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(20)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(21)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(22)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(23)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(24)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(25)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(26)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(27)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(28)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(29)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(30)]" operation="set" value="0"/>  
            <parameter name="[sqnArr(31)]" operation="set" value="0"/>  
            
            <parameter name="[NAS_msg]" operation="string.xpath" value="[nas_pdu_msg]" value2="//MessageType"/>
            <parameter name="[NAS_msg_type]" operation="string.xpath" value="[NAS_msg(2)]" value2="//MessageType/text()"/>

            <parameter name="[ret]" operation="set" value="false"/>  

            <parameter name="[selected_enc_alg]" operation="set" value=""/>
            <parameter name="[selected_int_alg]" operation="set" value=""/>

            <switch parameter="[NAS_msg_type]">
                <case equals="IdentityRequest">

                    <call name="identityReqsponse" >
                        <input>
                            <parameter name="[function:mobile_id]"  value="1111"/>
                        </input>

                        <output>
                            <parameter name="[function:id_msgd]" /> 
                        </output>
                    </call>

                    <parameter name="[send_nas_pdu_msgd]" operation="set" value="[id_msgd]"/>
                    <parameter name="[ret]" operation="set" value="true"/>  
                </case>

                <case equals="AuthenticationRequest">

                    <parameter name="[ksi]" operation="string.xpath" value="[nas_pdu_msg]" value2="//NasKeySetIdentifierValue/text()" />
                    <parameter name="[rand]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AuthenticationParameterRand[1]/Rand/text()" />
                    <parameter name="[SqnXorAk]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AuthenticationParameterAutn[1]/SqnXorAk/text()" />
                    <parameter name="[Amf]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AuthenticationParameterAutn[1]/Amf/text()" />
                    <parameter name="[Mac]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AuthenticationParameterAutn[1]/Mac/text()" />
                    
                    <parameter name="[abba]" operation="string.xpath" value="[nas_pdu_msg]" value2="//AbbaContent/text()" />

                    <call name="validateAutn" >
                        <input>
                            <parameter name="[function:rand]" value="[rand]" />
                            <parameter name="[function:sqn]" value="[SqnXorAk]" />
                            <parameter name="[function:amf]" value="[Amf]" />
                            <parameter name="[function:indBitLen]" value="[indBitLen]" />
                            <parameter name="[function:wrappingDelta]" value="[wrappingDelta]" />
                            <parameter name="[function:sqnArr]" value="[sqnArr]" />
                            <parameter name="[function:receivedMAC]" value="[Mac]" />
                        </input>

                        <output>
                            <parameter name="[function:validated]" /> 
                            <parameter name="[function:osqnArr]" />
                        </output>
                    </call>

                    <if>  <condition> <test parameter="[validated]" condition="string.equals" value="false"/></condition>
                        <then>
                            <exit name="exit" failed="false"/>  
                        </then>   
                    </if>
                    
                    <parameter name="[sqnArr]" operation="set" value="[osqnArr]"/>   

                    <call name="calcResp" >
                        <input>
                            <parameter name="[function:rand]" value="[rand]" />
                            <parameter name="[function:sqn]" value="[SqnXorAk]" />
                            <parameter name="[function:amf]" value="[Amf]" />
                            <parameter name="[function:indBitLen]" value="[indBitLen]" />
                            <parameter name="[function:wrappingDelta]" value="[wrappingDelta]" />
                            <parameter name="[function:sqnArr]" value="[sqnArr]" />
                            <parameter name="[function:receivedMAC]" value="[Mac] " />
                        </input>

                        <output> 
                            <parameter name="[function:resStar]" /> 
                            <parameter name="[function:key_ausf]" /> 
                        </output>
                    </call>

                    <parameter name="[ue_key_ausf]" operation="set" value="[key_ausf]"/>   
                    
                    <call name="AuthResp" >
                        <input>
                            <parameter name="[function:res_param]"  value="[resStar]"/>
                        </input>

                        <output> <parameter name="[function:Auth_msgd]" /> </output>
                    </call>

                    <parameter name="[oSeafAmf]" operation="protocol.setFromNAS" value="[ue_supi]" value2="SeafAmf" value3="[ue_snn]" value4="[abba]" value5="[ue_key_ausf]"/>
            
                    <parameter name="[ue_key_seaf]" operation="set" value="[oSeafAmf(0)]"/>   
                    <parameter name="[ue_key_amf]" operation="set" value="[oSeafAmf(1)]"/>   

                    <parameter name="[send_nas_pdu_msgd]" operation="set" value="[Auth_msgd]"/>   

                    <parameter name="[ret]" operation="set" value="true"/>   
                </case>

                <case equals="SecurityModeCommand">
                
                    <parameter name="[selected_enc_alg]" operation="string.xpath" value="[nas_pdu_msg]" value2="//TypeOfCipheringAlgorithm/text()"/>
                    <parameter name="[selected_int_alg]" operation="string.xpath" value="[nas_pdu_msg]" value2="//TypeOfIntegrityProtectionAlgorithm/text()"/>


                    <call name="securityComp" >
                        <input>
                            <parameter name="[function:mobile_id]"  value="11111"/>
                        </input>

                        <output> <parameter name="[function:sec_msgd]" /> </output>
                    </call>

                    <call name="encryptNasMessage" >
                        <input>
                            <parameter name="[function:plainNasMessage]" value="[sec_msgd]"/>
                        </input>
                        <output>
                            <parameter name="[function:out_encrypt_ret]" />
                            <parameter name="[function:out_encrypt_msg]" />
                        </output>
                    </call>

                    <parameter name="[send_nas_pdu_msgd]" operation="set" value="[sec_msgd]"/>  
                    <parameter name="[ret]" operation="set" value="true"/>  
                

                    <if> <condition> <test parameter="[selected_enc_alg]" condition="string.equals" value="" not="true"/> </condition>
                        <then>
                            <parameter name="[ue_selected_enc_alg]" operation="set" value="[selected_enc_alg]"/>  
                        </then>     
                    </if>

                    <if> <condition> <test parameter="[selected_int_alg]" condition="string.equals" value="" not="true"/> </condition>
                        <then>
                            <parameter name="[ue_selected_int_alg]" operation="set" value="[selected_int_alg]"/>  
                        </then>     
                    </if>

                    <call name="ConvertEncAlg" >
                        <output>
                            <parameter name="[function:out_enc_alg]" />
                        </output>
                    </call>   
                    
                    <call name="ConvertIntAlg" >
                        <output>
                            <parameter name="[function:out_int_alg]" />
                        </output>
                    </call>   

                    <parameter name="[nas_key]" operation="protocol.setFromNAS" value="[ue_key_amf]" value2="NasKey" value3="[out_enc_alg]" value4="[out_int_alg]"/>

                    <parameter name="[ue_selected_kNasEnc]" operation="set" value="[nas_key(0)]"/>  
                    <parameter name="[ue_selected_kNasInt]" operation="set" value="[nas_key(1)]"/>  
                </case>
            </switch>    
        </do>
      
        <output>
            <parameter name="[function:ret]" />
            <parameter name="[function:send_nas_pdu_msgd]" />
        </output>
    </function>
</scenario>
