<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->
<!--  name="Send 3GPP Cx/Dx User-Authorization request (UAR)" -->

<scenario>

            <!-- open a channel -->
    <openChannelNGAP name="channel_client" localHost="[localHostNGAP]" localPort="[localPortNGAP]"
                                 remoteHost="[remoteHostNGAP]" remotePort="[remotePortNGAP]"
                                 transport="[transport]"/>

    
    <sendMessageNGAP name="Send Notify1" channel="channel_client">
        <NGAP-PDU>
            <initiatingMessage>
                <procedureCode>21</procedureCode>
                <criticality>reject</criticality>
                <value>
                    <NGSetupRequest>
                        <protocolIEs>
                            <protocolIEs>
                                <id>27</id>
                                <criticality>reject</criticality>
                                <value>
                                    <GlobalRANNodeID>
                                        <globalGNB-ID>
                                         <pLMNIdentity>[PLMN_ID]</pLMNIdentity>
                                         <gNB-ID><gNB-ID>[GNB_ID]</gNB-ID></gNB-ID>
                                     </globalGNB-ID>
                                    </GlobalRANNodeID>
                                </value>
                            </protocolIEs>
                            <protocolIEs>
                                <id>82</id>
                                <criticality>ignore</criticality>
                                <value>
                                    <RANNodeName>gnb.test.com</RANNodeName>
                                </value>
                            </protocolIEs>
                            <protocolIEs>
                                <id>21</id>
                                <criticality>ignore</criticality>
                                <value>
                                    <PagingDRX>v32
                                    </PagingDRX>
                                </value>
                            </protocolIEs>
                            <protocolIEs>
                                <id>102</id>
                                <criticality>ignore</criticality>
                                <value>
                                    <SupportedTAList>
                                        <SupportedTAList>
                                            <tAC>[TAC]</tAC>
                                            <broadcastPLMNList>
                                            <broadcastPLMNList>
                                                <pLMNIdentity>[PLMN_ID]</pLMNIdentity>
                                                <tAISliceSupportList>
                                                <tAISliceSupportList>
                                                    <s-NSSAI>
                                                        <sST>[SST]</sST>
                                                        <sD>000001</sD>
                                                    </s-NSSAI>
                                                </tAISliceSupportList>
                                                </tAISliceSupportList>
                                            </broadcastPLMNList>
                                            </broadcastPLMNList>
                                        </SupportedTAList>
                                    </SupportedTAList>
                                </value>
                            </protocolIEs>
                        </protocolIEs>
                    </NGSetupRequest>
                </value>
            </initiatingMessage>
        </NGAP-PDU>
    </sendMessageNGAP>

    <log type="Scenario" level="INFO"> waiting ngsetup response</log>
    <parameter name="[received]" operation="set" value="false"/>        
    <receiveMessageNGAP name="wait_ngsetupresp" channel="channel_client" timeout="[timeout]" failedOnTimeout="true">
        <parameter name="[messageType]" operation="protocol.setFromMessage" value="message.type"/>
        <parameter name="[received]" operation="set" value="true"/> 
    </receiveMessageNGAP>

    <if>
        <condition>
            <test parameter="[received]" condition="string.equals" value="false"/>                                              
        </condition>
        <then>
           <exit name="exit" failed="false"/>
        </then>     
    </if>

    <if>
        <condition>
            <test parameter="[messageType]" condition="string.equals" value="NGSetupResponse"/>
        </condition>
        <then>
            <log type="Scenario" level="INFO">Received NGSetupResponse</log>
            <goto  name="goto_sendInitUE" label="sendInitUE" state="true"/>    
        </then>    
        <else>
            <log type="Scenario" level="ERROR">Received unexperted message</log>
            <exit name="exit" failed="false"/>
        </else>
    </if>

    <label name="begin"/>

    <log type="Scenario" level="INFO"> wait_ngap_message</log>
    <parameter name="[received]" operation="set" value="false"/>        
    <receiveMessageNGAP name="wait_ngap_message" channel="channel_client" timeout="[timeout]" failedOnTimeout="false">
        <parameter name="[messageType]" operation="protocol.setFromMessage" value="message.type"/>
        <parameter name="[messageContent]" operation="protocol.setFromMessage" value="message.xml"/>
        <parameter name="[received]" operation="set" value="true"/> 
    </receiveMessageNGAP>

    <if>
        <condition>
            <test parameter="[messageContent]" condition="string.contains" value="AMF-UE-NGAP-ID"/>
        </condition>
        <then>
            <parameter name="[AMF_UE_NGAP_ID]" operation="string.xpath" value="[messageContent]" value2="//AMF-UE-NGAP-ID/text()"/>
        </then>     
    </if>

    <if>
        <condition>
            <test parameter="[received]" condition="string.equals" value="false"/>                                              
        </condition>
        <then>
           <exit name="exit" failed="false"/>
        </then>     
    </if>

    <if>
        <condition>
            <test parameter="[messageContent]" condition="string.contains" value="NAS-PDU"/>
        </condition>
        <then>
            <parameter name="[NAS_PDU_RECV]" operation="string.xpath" value="[messageContent]" value2="//NAS-PDU/text()"/>
            <parameter name="[NAS_TYPE]" operation="string.substring" value="[NAS_PDU_RECV]" value2="3"/>
        </then>    
    </if>
    <log type="Scenario" level="INFO">Receiving Message : [messageType]: [NAS_PDU_RECV]: [NAS_TYPE]</log>

    <switch parameter="[messageType]">
        <case equals="DownlinkNASTransport">
            <if>
                <condition>
                    <test parameter="[NAS_TYPE]" condition="string.contains" value="0752"/>
                </condition>
                <then>
                </then>    
            </if>
            <if>
                <condition>
                    <test parameter="[NAS_TYPE]" condition="string.contains" value="075D"/>
                </condition>
                <then>
                    <parameter name="[NAS_PDU_CONTENT]"  operation="set"  value="[NAS_PDU_SEC_COMPL]" />
                    <log type="Scenario" level="INFO">Receing Security complete</log>
                </then>    
            </if>
            <log type="Scenario" level="INFO">Receiving DownlinkNASTransport</log>
            <goto  name="goto_sendUplinkNas" label="sendUplinkNas" state="true"/>   
        </case>
        <case equals="UEContextReleaseCommand">
            <log type="Scenario" level="INFO">Receiving UEContextReleaseCommand</log>
            <goto  name="goto_sendReleaseCompl" label="sendReleaseCompl" state="true"/>   
        </case>
    </switch>

    <if>
        <condition>
            <test parameter="[messageType]" condition="string.equals" value="DownlinkNASTransport"/>
        </condition>
        <then>
            <log type="Scenario" level="INFO">Receiving DownlinkNASTransport</log>
            <goto  name="goto_sendUplinkNas" label="sendUplinkNas" state="true"/>    
        </then>    
    </if>

    <goto  name="goto_begin" label="begin" state="true"/>     

    <label name="sendInitUE"/>    
    <log type="Scenario" level="ERROR">send InitialUEMessage</log>
        <!--parameter name="[localHosts]" operation="system.ipaddress" value2="[IPVersion]"/-->
    <sendMessageNGAP name="InitialUEMessage" channel="channel_client">
        <NGAP-PDU>
            <initiatingMessage>
                <procedureCode>15</procedureCode>
                <criticality>ignore</criticality>
                <value>
                    <InitialUEMessage>
                        <protocolIEs>
                            <protocolIEs>
                                <id>85</id>
                                <criticality>reject</criticality>
                                <value>
                                    <RAN-UE-NGAP-ID>[RAN_UE_NGAP_ID]</RAN-UE-NGAP-ID>
                                </value>
                            </protocolIEs>
                            <protocolIEs>
                                <id>38</id>
                                <criticality>reject</criticality>
                                <value>
                                    <NAS-PDU>
                                        7e004179000d0164f0110000000005221355401001032e02f0f01707f0f0c040018030
                                    </NAS-PDU>
                                </value>
                            </protocolIEs>
                            <protocolIEs>
                                <id>121</id>
                                <criticality>reject</criticality>
                                <value>
                                    <UserLocationInformation>
                                        <userLocationInformationNR>
                                            <nR-CGI>
                                                <pLMNIdentity>[PLMN_ID]</pLMNIdentity>
                                                <nRCellIdentity>[gnb_cell_id]</nRCellIdentity>
                                            </nR-CGI>
                                            <tAI>
                                                <pLMNIdentity>[PLMN_ID]</pLMNIdentity>
                                                <tAC>[TAC]</tAC>
                                            </tAI>
                                        </userLocationInformationNR>
                                    </UserLocationInformation>
                                </value>
                            </protocolIEs>
                            <protocolIEs>
                                <id>90</id>
                                <criticality>ignore</criticality>
                                <value>
                                    <RRCEstablishmentCause>mo-Signalling</RRCEstablishmentCause>
                                </value>
                            </protocolIEs>
                        </protocolIEs>
                    </InitialUEMessage>
                </value>
            </initiatingMessage>
        </NGAP-PDU>
    </sendMessageNGAP>


    <goto  name="goto_begin" label="begin" state="true"/>   

    <label name="sendUplinkNas"/>    
    <log type="Scenario" level="INFO">send UplinkNASTransport</log>
        <!--parameter name="[localHosts]" operation="system.ipaddress" value2="[IPVersion]"/-->
    <sendMessageNGAP name="UplinkNASTransport" channel="channel_client">
        <NGAP-PDU>
            <initiatingMessage>
                <procedureCode>46</procedureCode>
                <criticality>ignore</criticality>
                <value>
                    <UplinkNASTransport>
                        <protocolIEs>
                            <protocolIEs>
                                <id>85</id>
                                <criticality>reject</criticality>
                                <value>
                                    <RAN-UE-NGAP-ID>[RAN_UE_NGAP_ID]</RAN-UE-NGAP-ID>
                                </value>
                            </protocolIEs>
                            <protocolIEs>
                                <id>10</id>
                                <criticality>reject</criticality>
                                <value>
                                    <AMF-UE-NGAP-ID>[AMF_UE_NGAP_ID]</AMF-UE-NGAP-ID>
                                </value>
                            </protocolIEs>
                            <protocolIEs>
                                <id>38</id>
                                <criticality>reject</criticality>
                                <value>
                                    <NAS-PDU>[NAS_PDU_CONTENT]</NAS-PDU>
                                </value>
                            </protocolIEs>
                            <protocolIEs>
                                <id>121</id>
                                <criticality>reject</criticality>
                                <value>
                                    <UserLocationInformation>
                                        <userLocationInformationNR>
                                            <nR-CGI>
                                                <pLMNIdentity>[PLMN_ID]</pLMNIdentity>
                                                <nRCellIdentity>[gnb_cell_id]</nRCellIdentity>
                                            </nR-CGI>
                                            <tAI>
                                                <pLMNIdentity>[PLMN_ID]</pLMNIdentity>
                                                <tAC>[TAC]</tAC>
                                            </tAI>
                                        </userLocationInformationNR>
                                    </UserLocationInformation>
                                </value>
                            </protocolIEs>
                        </protocolIEs>
                    </UplinkNASTransport>
                </value>
            </initiatingMessage>
        </NGAP-PDU>

    </sendMessageNGAP>

    <goto  name="goto_begin" label="begin" state="true"/>   


    <label name="sendReleaseCompl"/>    
    <log type="Scenario" level="INFO">send UEContextReleaseComplete</log>
        <!--parameter name="[localHosts]" operation="system.ipaddress" value2="[IPVersion]"/-->
    <sendMessageNGAP name="UEContextReleaseComplete" channel="channel_client">
        <NGAP-PDU>
            <successfulOutcome>
                <procedureCode>23</procedureCode>
                <criticality>reject</criticality>
                <value>
                    <UEContextReleaseComplete>
                        <protocolIEs>
                            <protocolIEs>
                                <id>85</id>
                                <criticality>ignore</criticality>
                                <value>
                                    <RAN-UE-NGAP-ID>[RAN_UE_NGAP_ID]</RAN-UE-NGAP-ID>
                                </value>
                            </protocolIEs>
                        </protocolIEs>
                    </UEContextReleaseComplete>
                </value>
            </successfulOutcome>
        </NGAP-PDU>
    </sendMessageNGAP>

    <log type="Scenario" level="INFO">Test Successed!!!!!!</log>        

</scenario>
